## Стриминг видеофайлов
### Узнаем используемые в файле  кодеки
Пусть у нас в папке `G:\tmp лежит файл Test.mp4`. Открываем `ff-prompt.bat` и вводим команду
```
ffprobe -v quiet -show_entries stream=codec_name -print_format default=nk=1:nw=1 G:\tmp\Test.mp4
```
или просто
```
ffprobe G:\tmp\Test.mp4
```
но тогда программа выдаст вдобавок кучу ненужной информации.
В результате вы увидите используемые в данном файле видео и аудио кодеки. В моем случае это `h264` и `aac`, так что файл можно стримить без перекодировки.

![Вид командной строки](https://raw.githubusercontent.com/edunum/ffmeg-stream/master/img/003.png)

Ту же информацию можно узнать открыв файл любым видео-плеером и посмотрев через него свойства файла. Например в Media Player Classic это меню `Файл→Свойства`.

![MPC](https://raw.githubusercontent.com/edunum/ffmeg-stream/master/img/004.png)

### Стримим без перекодировки
Итак, приступим наконец к примерам. Рассмотрим вначале стриминг без перекодировки. Его преимущество в том, что процессор совершенно не нагружается. Тратятся только сетевые ресурсы на отправку потока. Но для этого ваш видеофайл должен содержать видео в формате `h.264`, а аудио в `MP3` или `AAC`.
Организуем стрим нашего файла на плеер кибергейма. Ссылка, по которой будет отправляться поток имеет следующий вид:
```
rtmp://st.cybergame.tv:1953/live/название_канала?key=*************
```
где вместо звездочек вставлен ваш ключ. Стрим запускается следующей командой
```
ffmpeg -re -loglevel error -i "G:/tmp/Test.mp4" -c copy -f flv rtmp://st.cybergame.tv:1953/live/7b48debe2etest?key=*
```
или так
```
ffmpeg -re -loglevel error -i "G:/tmp/Test.mp4" -codec:v copy -codec:a copy -f flv rtmp://st.cybergame.tv:1953/live/7b48debe2etest?key=*
```
Ключ | Что означает
---- | ----------- 
`-re` | считывать кадры с естественной скоростью (25 кадров в секунду)
`-loglevel error` | сообщать только об ошибках
`-i` | имя_файла путь к видео-файлу (входной файл)
`-с copy` | передавать видео и аудио как есть, без перекодировки (краткая запись двух опций ниже)
`-codec:v copy` | копировать видео-поток (v)
`-codec:a copy` | копировать аудио-поток (a)
`-f flv ссылка` | выходной поток формата flv отправлять по ссылке

на этом настройки стрима без перекодировки заканчиваются. Процесс не потребляет практически никаких ресурсов
![процесс ffmpeg](https://raw.githubusercontent.com/edunum/ffmeg-stream/master/img/005.png)

### Стримим с перекодировкой
В случае, если в файле использованы какие-то другие кодеки придется запускать стрим с перекодировкой. В этом случает придется указать большое количество параметров, поэтому удобнее использовать bat файл
```bat
"G:\Program Files\ffmpeg\bin\ffmpeg.exe" ^
    -re ^
    -loglevel error ^
    -i "G:\tmp\Test.mp4" ^
    -codec:v libx264 ^
    -preset ultrafast ^
    -profile:v main ^
    -minrate 2000k ^
    -maxrate 2000k ^
    -bufsize 2000k ^
    -g 60 ^
    -codec:a aac ^
    -b:a 128k ^
    -ar 44100 ^
    -f flv rtmp://st.cybergame.tv:1953/live/7b48debe2etest?key=******
pause
```

Ключ               | Что означает
-----------------  | ---------
`-codec:v libx264` | видеокодек
`-preset ultrafast` | предустановки кодека
`-profile:v main` | профиль кодека
`-minrate 2000k` | минимальный битрейт
`-maxrate 2000k` | максимальный битрейт
`-bufsize 2000k` | размер буфера битрейт
`-g 50` | настройка интервала ключевого кадра (key frame) (большинство стрим-сервисов требуют выставлять key frame равным 2, для этого выставляем параметр -g равным 50, то есть в два раза больше числа кадров в секунду 2*25)
`-codec:a aac` | аудиокодек
`-b:a 128k` | аудиобитрейт
`-ar 44100` | частота дискретизации

Выставляем одинаковый минимальный и максимальный битрейт для того, чтобы получить постоянный битрейт, который требуют большинство стримсервисов.