## Стриминг видеофайлов

### Узнаем используемые в файле  кодеки
Пусть у нас в папке `G:\tmp` лежит файл `Test.mp4`. Открываем `ff-prompt.bat` и вводим команду
```
ffprobe -v quiet -show_entries stream=codec_name -print_format default=nk=1:nw=1 G:\tmp\Test.mp4
```
или просто
```
ffprobe G:\tmp\Test.mp4
```
но тогда программа выдаст вдобавок кучу ненужной информации.
В результате вы увидите используемые в данном файле видео и аудио кодеки. В данном случае это `h264` и `aac`, так что файл можно стримить без перекодировки.

![Вид командной строки](https://raw.githubusercontent.com/edunum/ffmeg-stream/master/img/003.png)

Ту же информацию можно узнать открыв файл любым видео-плеером и посмотрев через него свойства файла. Например в Media Player Classic это меню `Файл→Свойства`.

![MPC](https://raw.githubusercontent.com/edunum/ffmeg-stream/master/img/004.png)

### Стримим без перекодировки

Если видео закодированно поддерживаемыми форматом `flv` кодеками (видео `h.264`, аудио `MP3` или `AAC`), то можно запустить стрим без переокодировки. В этом процессор совершенно не нагружается и тратятся только сетевые ресурсы на отправку видео-аудио потока.

Организуем стрим нашего файла стримсервис. Для этого надо знать название канала и ключ (stream-key). К примеру, для [cybergame.tv](http://cybergame.tv) ссылка, по которой будет отправляться поток, будет иметь следующий вид:
```
rtmp://st.cybergame.tv:1953/live/название_канала?key=*************
```
где вместо звездочек вставлен ваш ключ. Стрим без перекодировки запускается одной из следующих команд:
  1. `ffmpeg -re -loglevel error -i "файл" -c copy -f flv rtmp://ссылка`
  2. `ffmpeg -re -loglevel error -i "файл" -vcodec copy -acodec copy -f flv rtmp://ссылка`
  3. `ffmpeg -re -loglevel error -i "файл" -codec:v copy -codec:a copy -f flv rtmp://ссылка`

Ключ | Что означает
---- | -----------
`-re` | считывать кадры со скоростью, заданной в видеопотоке (обычно 25 кадров в секунду)
`-loglevel error` | сообщать только об ошибках
`-i` | имя_файла путь к видео-файлу (входной файл)
`-с copy` | передавать видео и аудио как есть, без перекодировки (краткая запись двух опций ниже)
`-codec:v copy` | копировать видео-поток (v)
`-codec:a copy` | копировать аудио-поток (a)
`-f flv ссылка` | выходной поток формата flv отправлять по ссылке

на этом настройки стрима без перекодировки заканчиваются. Процесс не потребляет практически никаких ресурсов
![процесс ffmpeg](https://raw.githubusercontent.com/edunum/ffmeg-stream/master/img/005.png)

### Стримим с перекодировкой
В случае, если в файле использованы какие-то другие кодеки придется запускать стрим с перекодировкой. В этом случает придется указать большое количество параметров, поэтому удобнее использовать bat файл
```bat
"G:\Program Files\ffmpeg\bin\ffmpeg.exe" ^
    -re ^
    -loglevel error ^
    -i "G:\tmp\Test.mp4" ^
    -codec:v libx264 ^
    -preset ultrafast ^
    -profile:v main ^
    -minrate 2000k ^
    -maxrate 2000k ^
    -bufsize 2000k ^
    -g 60 ^
    -codec:a aac ^
    -b:a 128k ^
    -ar 44100 ^
    -f flv rtmp://st.cybergame.tv:1953/live/7b48debe2etest?key=******
pause
```

Ключ               | Что означает
-----------------  | ---------
`-codec:v libx264` | видеокодек
`-preset ultrafast` | предустановки кодека
`-profile:v main` | профиль кодека
`-minrate 2000k` | минимальный битрейт
`-maxrate 2000k` | максимальный битрейт
`-bufsize 2000k` | размер буфера битрейт
`-g 50` | настройка интервала ключевого кадра (key frame) (большинство стрим-сервисов требуют выставлять key frame равным 2, для этого выставляем параметр -g равным 50, то есть в два раза больше числа кадров в секунду 2*25)
`-codec:a aac` | аудиокодек
`-b:a 128k` | аудиобитрейт
`-ar 44100` | частота дискретизации

Выставляем одинаковый минимальный и максимальный битрейт для того, чтобы получить постоянный битрейт, который требуют большинство стримсервисов. Величину битрейта выбираем в зависимости от разрешения видеофайла.
