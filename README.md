# Использование ffmpeg для стриминга

Стандартными программами для стриминга сегодня считаются `OBS` и `Xsplit`. Я же хочу рассказать об одной консольной программе под названием  `ffmpeg`. Об этой программе хорошо знают те, кто занимается северной частью стримов, так как это основное средство для кодирования и перекодирования аудио и видео потоков. Стримеры чаще всего о ней не знают.
Основное предназначение `ffmpeg` — кодирование и различные манипуляции с аудио и видео. Он позволяет сравнительно просто добавить или удалить звуковую дорожку, разделить видео-файл на части или же слить несколько файлов в один. Но кроме этого `ffmpeg` поддерживает `rtmp` протокол, который на сегодняшний день чаще всего и используется для стримов.

План статьи.
- Где взять `ffmpeg` и как как им пользоваться.
- Кратко о контейнерах и кодеках.
- Стриминг видео-файлов с кодировкой и без.
- Наложение текста и рамок поверх видеопотока.
- Рестриминг с перекодировкой и без.

## Установка ffmpeg на компьютер и запуск

Программа ffmpeg является консольной и все манипуляции будут производиться через консоль. Это касается как Виндовс, так и Линукс. Если вы используйте Линукс, то установить ffmpeg можно из официального репозитория, он там наверняка есть. Остальные же могут скачать готовый [набор программ по ссылке](https://ffmpeg.zeranoe.com/builds/)

![Внешний вид страницы, с которой надо скачать ffmpeg](https://raw.githubusercontent.com/edunum/ffmeg-stream/master/img/001.png)

Скачивайте архив на диск и распаковывайте в любую удобную папку, например в  `G:\Program Files\ffmpeg` (далее везде в примерах при необходимости буду использовать этот путь).

![Три исполняемых файла](https://raw.githubusercontent.com/edunum/ffmeg-stream/master/img/002.png)

В папке `bin` лежат три файла `ffmpeg.exe`, `ffplay.exe`, `ffprobe.exe`, но нам будет нужен только `ffmpeg.exe`. Полный путь до него:
```batch
G:\Program Files\ffmpeg\bin\ffmpeg.exe
```
В корне директории лежит файл `ff-prompt.bat`, при запуске которого откроется локальная командная строка, в которой уже прописаны все пути и можно вызывать `ffmpeg` не указывая абсолютный путь до исполняемого файла `ffmpeg.exe`. Такой консолью удобно пользоваться для тестов.
Как видите, никакого процесса установки не потребовалось, все файлы программы будут находиться в папке, которую вы создали.

## О контейнерах и кодеках

Прежде чем приступить к конкретным примерам, надо пару слов сказать о контейнерах и аудио/видео форматах. Если вы в этом разбирайтесь, то можете не читать.

- Медиаконтейнер — тип файла, в котором содержится видео, аудио дорожки, субтитры. К контейнерам относятся форматы avi, mp4, mkv и многие другие. 
- Формат видео определяется видео кодеком, которым это видео закодировано.
- Формат аудио определяется аудио кодеком, которым это аудио закодировано.

Разные медиоконтейнеры могут поддерживать разные кодеки. Нам понадобится знание о контейнерах `flv` и `mp4` и о протоколе `rtmp` (Real Time Messaging Protocol). Нужно разобраться какие кодеки поддерживает все из этих форматов, чтобы уяснить, в каких случаях для стрима понадобится перекодировка, а в каких нет.

| Контейнер | Видео кодек | Аудио кодек|
| --------- | ----------- | -----------|
| mp4       | h.264 | MP3, AAC |
| flv       | h.264 | MP3, AAC |
| rtmp      | h.264 | MP3, AAC|

Из таблички видно, что для видео надо использовать кодек `h.264` а для аудио или `MP3` или `AAC`. Сам по себе `MP4` поддерживает намного больше форматов, но для них понадобится перекодировка.

## Стриминг видеофайлов
### Узнаем используемые в файле  кодеки
Пусть у нас в папке `G:\tmp лежит файл Test.mp4`. Открываем `ff-prompt.bat` и вводим команду
```
ffprobe -v quiet -show_entries stream=codec_name -print_format default=nk=1:nw=1 G:\tmp\Test.mp4
```
или просто
```
ffprobe G:\tmp\Test.mp4
```
но тогда программа выдаст вдобавок кучу ненужной информации.
В результате вы увидите используемые в данном файле видео и аудио кодеки. В моем случае это `h264` и `aac`, так что файл можно стримить без перекодировки.

![Вид командной строки](https://raw.githubusercontent.com/edunum/ffmeg-stream/master/img/003.png)

Ту же информацию можно узнать открыв файл любым видео-плеером и посмотрев через него свойства файла. Например в Media Player Classic это меню `Файл→Свойства`.

![MPC](https://raw.githubusercontent.com/edunum/ffmeg-stream/master/img/004.png)

### Стримим без перекодировки
Итак, приступим наконец к примерам. Рассмотрим вначале стриминг без перекодировки. Его преимущество в том, что процессор совершенно не нагружается. Тратятся только сетевые ресурсы на отправку потока. Но для этого ваш видеофайл должен содержать видео в формате `h.264`, а аудио в `MP3` или `AAC`.
Организуем стрим нашего файла на плеер кибергейма. Ссылка, по которой будет отправляться поток имеет следующий вид:
```
rtmp://st.cybergame.tv:1953/live/название_канала?key=*************
```
где вместо звездочек вставлен ваш ключ. Стрим запускается следующей командой
```
ffmpeg -re -loglevel error -i "G:/tmp/Test.mp4" -c copy -f flv rtmp://st.cybergame.tv:1953/live/7b48debe2etest?key=*
```
или так
```
ffmpeg -re -loglevel error -i "G:/tmp/Test.mp4" -codec:v copy -codec:a copy -f flv rtmp://st.cybergame.tv:1953/live/7b48debe2etest?key=*
```
Ключ | Что означает
---- | ----------- 
`-re` | считывать кадры с естественной скоростью (25 кадров в секунду)
`-loglevel error` | сообщать только об ошибках
`-i` | имя_файла путь к видео-файлу (входной файл)
`-с copy` | передавать видео и аудио как есть, без перекодировки (краткая запись двух опций ниже)
`-codec:v copy` | копировать видео-поток (v)
`-codec:a copy` | копировать аудио-поток (a)
`-f flv ссылка` | выходной поток формата flv отправлять по ссылке

на этом настройки стрима без перекодировки заканчиваются. Процесс не потребляет практически никаких ресурсов
![процесс ffmpeg](https://raw.githubusercontent.com/edunum/ffmeg-stream/master/img/005.png)

### Стримим с перекодировкой
В случае, если в файле использованы какие-то другие кодеки придется запускать стрим с перекодировкой. В этом случает придется указать большое количество параметров, поэтому удобнее использовать bat файл
```bat
"G:\Program Files\ffmpeg\bin\ffmpeg.exe" ^
    -re ^
    -loglevel error ^
    -i "G:\tmp\Test.mp4" ^
    -codec:v libx264 ^
    -preset ultrafast ^
    -profile:v main ^
    -minrate 2000k ^
    -maxrate 2000k ^
    -bufsize 2000k ^
    -g 60 ^
    -codec:a aac ^
    -b:a 128k ^
    -ar 44100 ^
    -f flv rtmp://st.cybergame.tv:1953/live/7b48debe2etest?key=******
pause
```

Ключ | Что означает
---  | ---------
`-codec:v libx264` | видеокодек
`-preset ultrafast` | предустановки кодека
`-profile:v main` | профиль кодека
`-minrate 2000k` | минимальный битрейт
`-maxrate 2000k` | максимальный битрейт
`-bufsize 2000k` | размер буфера битрейт
`-g 50` | настройка интервала ключевого кадра (key frame) (большинство стрим-сервисов требуют выставлять key frame равным 2, для этого выставляем параметр -g равным 50, то есть в два раза больше числа кадров в секунду 2*25)
`-codec:a aac` | аудиокодек
`-b:a 128k` | аудиобитрейт
`-ar 44100` | частота дискретизации

Выставляем одинаковый минимальный и максимальный битрейт для того, чтобы получить постоянный битрейт, который требуют большинство стримсервисов.

## Наложение текста поверх видео

## Рестриминг с перекодировкой
